{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Новый" %} {{ is_supplier|yesno:_("поставщик,клиент") }} - Billify{% endblock %}

{% block extra_css %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="/static/css/clients/form.css">
<style>
    .client-form-page {
        max-width: 900px; /* Увеличение ширины формы */
    }
    
    .switch-toggles {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .toggle-container {
        background-color: var(--color-light-gray);
        border-radius: var(--radius-full);
        padding: 4px;
        position: relative;
        border: 1px solid var(--color-gray);
        height: 50px;
        transition: all 0.3s ease;
    }
    
    .toggle-options {
        display: flex;
        position: relative;
        z-index: 3;
        height: 100%;
    }
    
    .toggle-option {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        cursor: pointer;
        border-radius: var(--radius-full);
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        position: relative;
        z-index: 3;
        color: var(--color-text);
        height: 100%;
    }
    
    .toggle-option.active {
        color: white;
    }
    
    .toggle-slider {
        position: absolute;
        top: 4px;
        left: 4px;
        width: calc(50% - 4px);
        height: calc(100% - 8px);
        border-radius: var(--radius-full);
        background-color: var(--color-primary);
        transition: all 0.3s ease;
        z-index: 1;
    }
    
    .entity-toggle[data-active="supplier"] .toggle-slider {
        transform: translateX(100%);
    }
    
    .type-toggle[data-active="business"] .toggle-slider {
        transform: translateX(100%);
    }
    
    .toggle-container:hover {
        border-color: var(--color-primary);
    }
    
    .toggle-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--color-text);
        font-size: 0.9rem;
    }
    
    /* Стили для инпутов и контролов */
    .form-control {
        width: 100%;
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
        border: 1px solid #e9ecef;
        border-radius: 16px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--color-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(94, 114, 228, 0.15);
    }
    
    /* Сетка для трех полей в строку */
    .form-grid-triple {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    /* Стили для адресной формы */
    .address-form {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        margin-top: 5px;
    }
    
    .address-form .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
    }
    
    .address-form .form-group {
        margin-bottom: 10px;
    }
    
    .address-form label {
        font-size: 0.85rem;
        margin-bottom: 3px;
    }
    
    /* Стили для валидации */
    .form-control.error {
        border-color: #dc3545;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }
    
    .error-message.show {
        display: block;
    }
    
    /* Адаптивность для мобильных устройств */
    @media (max-width: 992px) {
        .toggle-container {
            height: 46px;
        }
        
        .toggle-option {
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 768px) {
        .switch-toggles {
            grid-template-columns: 1fr;
        }
        
        .form-grid-triple {
            grid-template-columns: 1fr;
        }
        
        .address-form .form-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    @media (max-width: 576px) {
        .step-label {
            display: none;
        }
        
        .address-form .form-grid {
            grid-template-columns: 1fr;
        }
        
        .toggle-container {
            height: 42px;
        }
        
        .toggle-option {
            font-size: 0.85rem;
        }
    }
    
    .summary-container {
        margin-top: 30px;
        margin-bottom: 20px;
    }
    
    .summary-container h3 {
        margin-bottom: 20px;
        color: #444;
        font-size: 1.2rem;
    }
    
    .summary-section {
        background-color: #f9f9f9;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .summary-section-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        font-size: 1rem;
        padding-bottom: 8px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 5px;
    }
    
    .summary-row {
        display: grid;
        grid-template-columns: 1fr 2fr;
        padding: 6px 0;
    }
    
    .summary-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .summary-value {
        font-weight: 500;
        color: #333;
        font-size: 0.9rem;
    }

    .autosave-info {
        margin-top: 10px;
        padding: 8px 12px;
        background-color: #f3f4f6;
        border-radius: 6px;
        color: #666;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .autosave-info i {
        color: #4caf50;
        font-size: 14px;
    }
    
    /* Стили оформления для формы */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--color-text);
        margin-bottom: 8px;
    }
    
    /* Кнопки */
    .btn {
        padding: 0.8rem 1.5rem;
        border-radius: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary {
        background-color: var(--color-primary);
        color: white;
    }
    
    .btn-primary:hover {
        background-color: var(--color-primary-dark);
    }
    
    .btn-secondary {
        background-color: #f0f0f0;
        color: var(--color-text);
    }
    
    .btn-secondary:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="client-form-page">
        <div class="breadcrumbs">
        <a href="{% url 'clients:list' %}">{% trans "Все клиенты" %}</a> / <span>{% trans "Новый" %} {% if is_supplier %}{% trans "поставщик" %}{% else %}{% trans "клиент" %}{% endif %}</span>
        </div>
        
    <h1>{% trans "Новый" %} {% if is_supplier %}{% trans "поставщик" %}{% else %}{% trans "клиент" %}{% endif %}</h1>
    
    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} alert-dismissible">
            {{ message }}
            <button type="button" class="close-alert" onclick="this.parentElement.style.display='none';">&times;</button>
    </div>
        {% endfor %}
    </div>
    {% endif %}
    
        <div class="wizard-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">{% trans "Основная информация" %}</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
            <div class="step-label">{% trans "Контактные данные" %}</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
            <div class="step-label">{% trans "Банковские реквизиты" %}</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
            <div class="step-label">{% trans "Дополнительно" %}</div>
            </div>
        </div>
        
    <form method="post" action="{% url 'clients:create' %}" class="client-form">
            {% csrf_token %}
        <input type="hidden" id="entity_type" name="entity_type" value="{% if is_supplier %}supplier{% else %}client{% endif %}">
        <input type="hidden" id="type" name="type" value="{% if form_data and form_data.type %}{{ form_data.type }}{% else %}individual{% endif %}">
        <input type="hidden" id="full_address" name="address" value="{% if form_data %}{{ form_data.address }}{% endif %}">
            
            <div class="wizard-panel active" data-panel="1">
                <div class="form-grid">
                <div class="full-width">
                        <div class="switch-toggles">
                            <div>
                                <label class="toggle-label">{% trans "Статус" %}</label>
                            <div class="toggle-container entity-toggle" id="entity-toggle" data-active="{% if is_supplier %}supplier{% else %}client{% endif %}">
                                    <div class="toggle-options">
                                    <div class="toggle-option {% if not is_supplier %}active{% endif %}" data-value="client">{% trans "Клиент" %}</div>
                                    <div class="toggle-option {% if is_supplier %}active{% endif %}" data-value="supplier">{% trans "Поставщик" %}</div>
                                    </div>
                                <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div>
                            <label class="toggle-label">{% trans "Тип" %}</label>
                            <div class="toggle-container type-toggle" id="type-toggle" data-active="{% if form_data and form_data.type == 'business' %}business{% else %}individual{% endif %}">
                                    <div class="toggle-options">
                                    <div class="toggle-option {% if not form_data or form_data.type != 'business' %}active{% endif %}" data-value="individual">{% trans "Физическое лицо" %}</div>
                                    <div class="toggle-option {% if form_data and form_data.type == 'business' %}active{% endif %}" data-value="business">{% trans "Юридическое лицо" %}</div>
                                    </div>
                                <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <div class="full-width">
                        <div class="form-group">
                        <label for="name">{{ is_supplier|yesno:_("Название организации / ФИО ИП,Имя / Название организации") }}</label>
                        <input type="text" id="name" name="name" class="form-control" required value="{% if form_data %}{{ form_data.name }}{% endif %}">
                    </div>
                        </div>
                    
                <div class="full-width">
                    <h3>{% trans "Адрес" %}</h3>
                    <div class="address-grid">
                        <div class="form-group">
                            <label for="region">{% trans "Область/Край" %}</label>
                            <input type="text" id="region" name="region" class="form-control" value="{% if form_data %}{{ form_data.region }}{% endif %}">
                        </div>
                        
                        <div class="form-group">
                            <label for="city">{% trans "Город/Населенный пункт" %}</label>
                            <input type="text" id="city" name="city" class="form-control" value="{% if form_data %}{{ form_data.city }}{% endif %}">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="street">{% trans "Улица" %}</label>
                            <input type="text" id="street" name="street" class="form-control" value="{% if form_data %}{{ form_data.street }}{% endif %}">
                    </div>
                    
                        <div class="form-group">
                            <label for="house">{% trans "Дом" %}</label>
                            <input type="text" id="house" name="house" class="form-control" value="{% if form_data %}{{ form_data.house }}{% endif %}">
                        </div>
                        
                        <div class="form-group">
                            <label for="apartment">{% trans "Квартира/Офис" %}</label>
                            <input type="text" id="apartment" name="apartment" class="form-control" value="{% if form_data %}{{ form_data.apartment }}{% endif %}">
                    </div>
                    
                        <div class="form-group">
                            <label for="postal_code">{% trans "Индекс" %}</label>
                            <input type="text" id="postal_code" name="postal_code" class="form-control" value="{% if form_data %}{{ form_data.postal_code }}{% endif %}">
                        </div>
                    </div>
                    </div>
                </div>
                
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-button">{% trans "Отмена" %}</button>
                    <button type="button" class="btn btn-primary next-step" data-goto="2">{% trans "Далее" %}</button>
                </div>
            </div>
            
            <div class="wizard-panel" data-panel="2">
                            <div class="form-grid">
                                <div class="form-group">
                    <label for="email">{% trans "Email" %}</label>
                    <input type="email" id="email" name="email" class="form-control" value="{% if form_data %}{{ form_data.email }}{% endif %}">
                                </div>
                                
                                <div class="form-group">
                    <label for="phone">{% trans "Телефон" %}</label>
                    <input type="tel" id="phone" name="phone" class="form-control" value="{% if form_data %}{{ form_data.phone }}{% endif %}">
                                </div>
                                
                                <div class="form-group">
                    <label for="contact_person">{% trans "Контактное лицо" %}</label>
                    <input type="text" id="contact_person" name="contact_person" class="form-control" value="{% if form_data %}{{ form_data.contact_person }}{% endif %}">
                                </div>
                                
                                <div class="form-group">
                    <label for="contact_email">{% trans "Email контактного лица" %}</label>
                    <input type="email" id="contact_email" name="contact_email" class="form-control" value="{% if form_data %}{{ form_data.contact_email }}{% endif %}">
                                </div>
                                </div>
                                
            <div class="form-actions">
                <button type="button" class="btn btn-secondary prev-step" data-goto="1">{% trans "Назад" %}</button>
                    <button type="button" class="btn btn-primary next-step" data-goto="3">{% trans "Далее" %}</button>
                </div>
            </div>
            
            <div class="wizard-panel" data-panel="3">
                <div class="form-grid">
                <div class="full-width">
                    <h3>{% trans "Банковские реквизиты" %}</h3>
                </div>
                
                    <div class="form-group">
                        <label for="tax_id">{% trans "ИНН" %}</label>
                    <input type="text" id="tax_id" name="tax_id" class="form-control" value="{% if form_data %}{{ form_data.tax_id }}{% endif %}">
                    </div>
                    
                <div class="form-group">
                        <label for="kpp">{% trans "КПП" %}</label>
                    <input type="text" id="kpp" name="kpp" class="form-control" value="{% if form_data %}{{ form_data.kpp }}{% endif %}">
                    </div>
                    
                    <div class="form-group">
                        <label for="ogrn">{% trans "ОГРН / ОГРНИП" %}</label>
                    <input type="text" id="ogrn" name="ogrn" class="form-control" value="{% if form_data %}{{ form_data.ogrn }}{% endif %}">
                    </div>
                    
                    <div class="form-group">
                        <label for="bank_name">{% trans "Название банка" %}</label>
                    <input type="text" id="bank_name" name="bank_name" class="form-control" value="{% if form_data %}{{ form_data.bank_name }}{% endif %}">
                    </div>
                    
                    <div class="form-group">
                    <label for="bank_bik">{% trans "БИК" %}</label>
                    <input type="text" id="bank_bik" name="bank_bik" class="form-control" value="{% if form_data %}{{ form_data.bank_bik }}{% endif %}">
                    </div>
                    
                    <div class="form-group">
                    <label for="bank_account">{% trans "Расчетный счет" %}</label>
                    <input type="text" id="bank_account" name="bank_account" class="form-control" value="{% if form_data %}{{ form_data.bank_account }}{% endif %}">
                </div>
                
                <div class="form-group">
                    <label for="bank_corr_account">{% trans "Корреспондентский счет" %}</label>
                    <input type="text" id="bank_corr_account" name="bank_corr_account" class="form-control" value="{% if form_data %}{{ form_data.bank_corr_account }}{% endif %}">
                    </div>
                </div>
                
            <div class="form-actions">
                <button type="button" class="btn btn-secondary prev-step" data-goto="2">{% trans "Назад" %}</button>
                    <button type="button" class="btn btn-primary next-step" data-goto="4">{% trans "Далее" %}</button>
                </div>
            </div>
            
            <div class="wizard-panel" data-panel="4">
            <div class="form-grid">
                <div class="full-width">
                <div class="form-group">
                    <label for="comment">{% trans "Комментарий" %}</label>
                        <textarea id="comment" name="comment" class="form-control" rows="3" placeholder="{% trans "Введите дополнительную информацию" %}">{% if form_data %}{{ form_data.comment }}{% endif %}</textarea>
                </div>
                    </div>
                </div>
                
            <div class="form-actions">
                <button type="button" class="btn btn-secondary prev-step" data-goto="3">{% trans "Назад" %}</button>
                <button type="submit" class="btn btn-primary" id="submit-button">{% trans "Сохранить" %}</button>
                </div>
            </div>
        </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для получения параметров из URL
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // Установить состояние по параметрам из URL, если они есть
    const urlEntityType = getUrlParameter('entity_type');
    if (urlEntityType && (urlEntityType === 'supplier' || urlEntityType === 'client')) {
        document.getElementById('entity_type').value = urlEntityType;
        document.getElementById('entity-toggle').setAttribute('data-active', urlEntityType);
        
        document.querySelectorAll('#entity-toggle .toggle-option').forEach(function(opt) {
            if (opt.getAttribute('data-value') === urlEntityType) {
                opt.classList.add('active');
            } else {
                opt.classList.remove('active');
            }
        });
        
        // Обновляем заголовки, если необходимо
        if (urlEntityType === 'supplier') {
            const titleLabels = document.querySelectorAll('h1, .breadcrumbs span');
            titleLabels.forEach(label => {
                if (label.tagName === 'H1') {
                    label.textContent = '{% trans "Новый" %} поставщик';
                } else {
                    label.textContent = '{% trans "Новый" %} поставщик';
                }
            });
            
            // Обновляем метку имени
            const nameLabel = document.querySelector('label[for="name"]');
            if (nameLabel) {
                nameLabel.textContent = 'Название организации / ФИО ИП';
            }
        }
    }
    
    // Функции валидации финансовых реквизитов
    
    // Валидация ИНН
    function validateINN(inn) {
        // ИНН юридического лица - 10 цифр, физического лица - 12 цифр
        const isLegalEntity = document.getElementById('type').value === 'business';
        
        if (isLegalEntity && inn.length !== 10) {
            return { valid: false, message: 'ИНН юридического лица должен содержать 10 цифр' };
        } else if (!isLegalEntity && inn.length !== 12) {
            return { valid: false, message: 'ИНН физического лица должен содержать 12 цифр' };
        }
        
        if (!/^\d+$/.test(inn)) {
            return { valid: false, message: 'ИНН должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Валидация КПП
    function validateKPP(kpp) {
        if (kpp === '') return { valid: true }; // КПП необязателен для физических лиц
        
        if (kpp.length !== 9) {
            return { valid: false, message: 'КПП должен содержать 9 цифр' };
        }
        
        if (!/^\d+$/.test(kpp)) {
            return { valid: false, message: 'КПП должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Валидация ОГРН/ОГРНИП
    function validateOGRN(ogrn) {
        if (ogrn === '') return { valid: true }; // ОГРН необязателен
        
        const isLegalEntity = document.getElementById('type').value === 'business';
        
        if (isLegalEntity && ogrn.length !== 13) {
            return { valid: false, message: 'ОГРН юридического лица должен содержать 13 цифр' };
        } else if (!isLegalEntity && ogrn.length !== 15) {
            return { valid: false, message: 'ОГРНИП физического лица должен содержать 15 цифр' };
        }
        
        if (!/^\d+$/.test(ogrn)) {
            return { valid: false, message: 'ОГРН должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Валидация БИК
    function validateBIK(bik) {
        if (bik === '') return { valid: true }; // БИК необязателен
        
        if (bik.length !== 9) {
            return { valid: false, message: 'БИК должен содержать 9 цифр' };
        }
        
        if (!/^\d+$/.test(bik)) {
            return { valid: false, message: 'БИК должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Валидация расчетного счета
    function validateBankAccount(account) {
        if (account === '') return { valid: true }; // Расчетный счет необязателен
        
        if (account.length !== 20) {
            return { valid: false, message: 'Расчетный счет должен содержать 20 цифр' };
        }
        
        if (!/^\d+$/.test(account)) {
            return { valid: false, message: 'Расчетный счет должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Валидация корреспондентского счета
    function validateCorrAccount(account) {
        if (account === '') return { valid: true }; // Корр. счет необязателен
        
        if (account.length !== 20) {
            return { valid: false, message: 'Корреспондентский счет должен содержать 20 цифр' };
        }
        
        if (!/^\d+$/.test(account)) {
            return { valid: false, message: 'Корреспондентский счет должен содержать только цифры' };
        }
        
        return { valid: true };
    }
    
    // Показать сообщение об ошибке
    function showError(inputElement, message) {
        // Создаем блок сообщения об ошибке, если его нет
        let errorElement = inputElement.parentElement.querySelector('.error-message');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            inputElement.parentElement.appendChild(errorElement);
        }
        
        inputElement.classList.add('error');
        errorElement.textContent = message;
        errorElement.classList.add('show');
    }
    
    // Скрыть сообщение об ошибке
    function hideError(inputElement) {
        inputElement.classList.remove('error');
        const errorElement = inputElement.parentElement.querySelector('.error-message');
        if (errorElement) {
            errorElement.classList.remove('show');
        }
    }
    
    // Привязать валидацию к полям формы
    const taxIdInput = document.getElementById('tax_id');
    if (taxIdInput) {
        taxIdInput.addEventListener('blur', function() {
            const result = validateINN(this.value);
            if (!result.valid && this.value !== '') {
                showError(this, result.message);
                } else {
                hideError(this);
            }
        });
    }
    
    const kppInput = document.getElementById('kpp');
    if (kppInput) {
        kppInput.addEventListener('blur', function() {
            const result = validateKPP(this.value);
            if (!result.valid) {
                showError(this, result.message);
                    } else {
                hideError(this);
            }
        });
    }
    
    const ogrnInput = document.getElementById('ogrn');
    if (ogrnInput) {
        ogrnInput.addEventListener('blur', function() {
            const result = validateOGRN(this.value);
            if (!result.valid) {
                showError(this, result.message);
            } else {
                hideError(this);
            }
        });
    }
    
    const bikInput = document.getElementById('bank_bik');
    if (bikInput) {
        bikInput.addEventListener('blur', function() {
            const result = validateBIK(this.value);
            if (!result.valid) {
                showError(this, result.message);
            } else {
                hideError(this);
            }
        });
    }
    
    const accountInput = document.getElementById('bank_account');
    if (accountInput) {
        accountInput.addEventListener('blur', function() {
            const result = validateBankAccount(this.value);
            if (!result.valid) {
                showError(this, result.message);
            } else {
                hideError(this);
            }
        });
    }
    
    const corrAccountInput = document.getElementById('bank_corr_account');
    if (corrAccountInput) {
        corrAccountInput.addEventListener('blur', function() {
            const result = validateCorrAccount(this.value);
            if (!result.valid) {
                showError(this, result.message);
                } else {
                hideError(this);
            }
        });
    }
    
    // Обновление валидации при изменении типа организации
    document.querySelectorAll('#type-toggle .toggle-option').forEach(function(option) {
        option.addEventListener('click', function() {
            // Сбрасываем ошибки валидации, т.к. требования изменились
            if (taxIdInput && taxIdInput.value) {
                const result = validateINN(taxIdInput.value);
                if (!result.valid) {
                    showError(taxIdInput, result.message);
            } else {
                    hideError(taxIdInput);
                }
            }
            
            if (ogrnInput && ogrnInput.value) {
                const result = validateOGRN(ogrnInput.value);
                if (!result.valid) {
                    showError(ogrnInput, result.message);
                } else {
                    hideError(ogrnInput);
                }
            }
        });
    });
    
    // Валидация формы перед отправкой
    document.querySelector('form').addEventListener('submit', function(e) {
        let hasErrors = false;
        
        // Валидируем все поля перед отправкой
        if (taxIdInput && taxIdInput.value) {
            const result = validateINN(taxIdInput.value);
            if (!result.valid) {
                showError(taxIdInput, result.message);
                hasErrors = true;
            }
        }
        
        if (kppInput && kppInput.value) {
            const result = validateKPP(kppInput.value);
            if (!result.valid) {
                showError(kppInput, result.message);
                hasErrors = true;
            }
        }
        
        if (ogrnInput && ogrnInput.value) {
            const result = validateOGRN(ogrnInput.value);
            if (!result.valid) {
                showError(ogrnInput, result.message);
                hasErrors = true;
            }
        }
        
        if (bikInput && bikInput.value) {
            const result = validateBIK(bikInput.value);
            if (!result.valid) {
                showError(bikInput, result.message);
                hasErrors = true;
            }
        }
        
        if (accountInput && accountInput.value) {
            const result = validateBankAccount(accountInput.value);
            if (!result.valid) {
                showError(accountInput, result.message);
                hasErrors = true;
            }
        }
        
        if (corrAccountInput && corrAccountInput.value) {
            const result = validateCorrAccount(corrAccountInput.value);
            if (!result.valid) {
                showError(corrAccountInput, result.message);
                hasErrors = true;
            }
        }
        
        // Если есть ошибки, отменяем отправку формы и прокручиваем к первой ошибке
        if (hasErrors) {
            e.preventDefault();
            const firstError = document.querySelector('.form-control.error');
            if (firstError) {
                // Найдем панель, содержащую ошибку
                const panel = firstError.closest('.wizard-panel');
                if (panel) {
                    // Определим номер панели
                    const panelNum = panel.getAttribute('data-panel');
                    // Переключимся на эту панель
                    switchToStep(panelNum);
                    // Прокрутим к первой ошибке
                    firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }
        } else {
            // Собираем компоненты адреса
            const region = document.getElementById('region').value;
            const city = document.getElementById('city').value;
            const street = document.getElementById('street').value;
            const house = document.getElementById('house').value;
            const apartment = document.getElementById('apartment').value;
            const postalCode = document.getElementById('postal_code').value;
            
            // Формируем полный адрес
            let fullAddress = '';
            
            if (region) fullAddress += region + ', ';
            if (city) fullAddress += city + ', ';
            if (street) fullAddress += 'ул. ' + street;
            if (house) fullAddress += ', д. ' + house;
            if (apartment) fullAddress += ', кв./офис ' + apartment;
            if (postalCode) fullAddress += ', ' + postalCode;
            
            // Устанавливаем значение скрытого поля
            document.getElementById('full_address').value = fullAddress;
        }
    });
    
    // Обработка кнопки отмены
    document.getElementById('cancel-button').addEventListener('click', function() {
        window.location.href = '{% url "clients:list" %}';
    });
    
    // Обработка переключения Клиент/Поставщик
    const entityToggle = document.getElementById('entity-toggle');
    const entityInput = document.getElementById('entity_type');
    const entityOptions = entityToggle.querySelectorAll('.toggle-option');
    
    entityOptions.forEach(function(option) {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            entityInput.value = value;
            entityToggle.setAttribute('data-active', value);
            
            // Снимаем активный класс со всех опций
            entityOptions.forEach(function(opt) { 
                opt.classList.remove('active');
            });
            // Добавляем активный класс выбранной опции
            this.classList.add('active');
            
            // Обновляем заголовки и метки вместо редиректа
            const entityType = value === 'supplier' ? 'поставщик' : 'клиент';
            const titleLabels = document.querySelectorAll('h1, .breadcrumbs span');
            titleLabels.forEach(label => {
                if (label.tagName === 'H1') {
                    label.textContent = `{% trans "Новый" %} ${entityType}`;
                } else {
                    label.textContent = `{% trans "Новый" %} ${entityType}`;
                }
            });
            
            // Обновляем метку имени в зависимости от типа
            const nameLabel = document.querySelector('label[for="name"]');
            if (nameLabel) {
                nameLabel.textContent = value === 'supplier' ? 
                    'Название организации / ФИО ИП' : 
                    'Имя / Название организации';
            }
            
            // Обновляем URL без перезагрузки страницы
            const url = new URL(window.location.href);
            if (value === 'supplier') {
                url.searchParams.set('entity_type', 'supplier');
            } else {
                url.searchParams.delete('entity_type');
            }
            window.history.pushState({}, '', url.toString());
        });
    });
    
    // Обработка переключения Физ. лицо/Юр. лицо
    const typeToggle = document.getElementById('type-toggle');
    const typeInput = document.getElementById('type');
    const typeOptions = typeToggle.querySelectorAll('.toggle-option');
    
    typeOptions.forEach(function(option) {
        option.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            typeInput.value = value;
            typeToggle.setAttribute('data-active', value);
            
            // Снимаем активный класс со всех опций
            typeOptions.forEach(function(opt) { 
                opt.classList.remove('active');
            });
            // Добавляем активный класс выбранной опции
            this.classList.add('active');
            
            // Запускаем проверку полей при изменении типа организации
            if (taxIdInput && taxIdInput.value) {
                const result = validateINN(taxIdInput.value);
                if (!result.valid) {
                    showError(taxIdInput, result.message);
                } else {
                    hideError(taxIdInput);
                }
            }
            
            if (ogrnInput && ogrnInput.value) {
                const result = validateOGRN(ogrnInput.value);
                if (!result.valid) {
                    showError(ogrnInput, result.message);
                } else {
                    hideError(ogrnInput);
                }
            }
        });
    });
    
    // Обработка переключения между этапами
    const steps = document.querySelectorAll('.step');
    const panels = document.querySelectorAll('.wizard-panel');
    const nextButtons = document.querySelectorAll('.next-step');
    const prevButtons = document.querySelectorAll('.prev-step');
    
    // Функция переключения этапа
    function switchToStep(stepNumber) {
        // Активируем нужный этап
        steps.forEach(function(step) {
            if (step.getAttribute('data-step') === stepNumber.toString()) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        // Активируем нужную панель
        panels.forEach(function(panel) {
            if (panel.getAttribute('data-panel') === stepNumber.toString()) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        });
        
        // Отмечаем пройденные этапы
        steps.forEach(function(step) {
            const stepNum = parseInt(step.getAttribute('data-step'));
            if (stepNum < stepNumber) {
                step.classList.add('completed');
            } else {
                step.classList.remove('completed');
            }
        });
        
        // Прокрутка страницы вверх для удобного просмотра следующего шага на мобильных
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    // Обработчики для кнопок "Далее"
    nextButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const nextStep = this.getAttribute('data-goto');
            switchToStep(nextStep);
        });
    });
    
    // Обработчики для кнопок "Назад"
    prevButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const prevStep = this.getAttribute('data-goto');
            switchToStep(prevStep);
        });
    });
    
    // Обработчики для клика по номерам этапов
    steps.forEach(function(step) {
        step.addEventListener('click', function() {
            const stepNum = this.getAttribute('data-step');
            switchToStep(stepNum);
        });
    });
    
    // Обработка мобильной адаптации
    function handleMobileAdaptation() {
        const isMobile = window.innerWidth <= 768;
        const isSmallScreen = window.innerWidth <= 600;
        
        if (isMobile) {
            // Дополнительная адаптация для мобильных устройств
            document.querySelectorAll('.step-number').forEach(function(number) {
                number.style.width = '35px';
                number.style.height = '35px';
            });
        }
        
        if (isSmallScreen) {
            // Дополнительная адаптация для очень маленьких экранов
            document.querySelectorAll('.step-number').forEach(function(number) {
                number.style.width = '30px';
                number.style.height = '30px';
                number.style.fontSize = '0.8rem';
            });
            
            // Скрываем текстовые метки шагов
            document.querySelectorAll('.step-label').forEach(function(label) {
                label.style.display = 'none';
            });
        } else {
            // Показываем текстовые метки для больших экранов
            document.querySelectorAll('.step-label').forEach(function(label) {
                label.style.display = 'block';
            });
        }
    }
    
    // Вызываем функцию при загрузке и при изменении размера окна
    handleMobileAdaptation();
    window.addEventListener('resize', handleMobileAdaptation);
});
</script>
{% endblock %} 
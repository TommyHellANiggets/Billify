{% extends 'base.html' %}
{% load static %}

{% block title %}Профиль компании{% endblock %}

{% block meta_description %}Управление профилем вашей компании в системе Billify. Редактируйте контактные данные, логотип, банковские реквизиты и другую информацию о вашей организации.{% endblock %}

{% block meta_keywords %}профиль компании, данные организации, настройки компании, реквизиты, управление профилем{% endblock %}

{% block og_title %}Управление профилем компании | Billify{% endblock %}
{% block og_description %}Управление профилем вашей компании в системе Billify. Редактируйте контактные данные, логотип, банковские реквизиты и другую информацию о вашей организации.{% endblock %}
{% block og_image %}{% static 'images/og/profile-og.jpg' %}{% endblock %}
{% block og_type %}website{% endblock %}

{% block meta_extra %}
<meta property="vk:image" content="{% static 'images/og/profile-og.jpg' %}" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Управление профилем компании | Billify" />
<meta name="twitter:description" content="Управление профилем вашей компании в системе Billify. Редактируйте контактные данные, логотип, банковские реквизиты и другую информацию." />
<meta name="twitter:image" content="{% static 'images/og/profile-og.jpg' %}" />
<meta name="robots" content="index, follow" />
<meta name="yandex-verification" content="verification_token" />
<link rel="canonical" href="{{ request.build_absolute_uri }}" />
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/global.css' %}">
<link rel="stylesheet" href="{% static 'css/core/profile.css' %}">
<style>
    .company-type-toggle {
        display: flex;
        width: 100%;
        margin-bottom: 10px;
        border-radius: var(--radius-full);
        overflow: hidden;
        background-color: var(--color-light-gray);
        border: 1px solid var(--color-gray);
    }
    
    .company-type-toggle label {
        flex: 1;
        text-align: center;
        padding: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .company-type-toggle input[type="radio"] {
        display: none;
    }
    
    .company-type-toggle input[type="radio"]:checked + label {
        background-color: var(--color-primary);
        color: white;
    }
    
    .file-upload-container {
        position: relative;
        width: 100%;
    }
    
    .file-upload-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: var(--color-light-gray);
        border: 1px solid var(--color-gray);
        border-radius: var(--radius);
        cursor: pointer;
        margin-top: 5px;
    }
    
    .file-upload-button:hover {
        background-color: var(--color-gray);
    }
    
    .file-upload-container input[type="file"] {
        position: absolute;
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        z-index: -1;
    }
    
    .file-name {
        margin-left: 10px;
        font-size: 0.9em;
        color: var(--color-text-light);
    }
    
    .current-file {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid var(--color-gray);
        border-radius: var(--radius);
        background-color: var(--color-light);
    }
    
    .current-file img {
        display: block;
        margin-bottom: 10px;
    }
    
    /* Переопределяем стиль сетки на 3 колонки */
    .form-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    /* Медиа запрос для мобильных устройств */
    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="profile-title">Профиль компании</h1>
    <p class="page-description">Управление профилем компании и настройками аккаунта</p>
</div>

<div class="profile-container">
    <!-- Боковая панель с навигацией -->
    <div class="profile-sidebar">
        <div class="profile-sidebar-header">
            <div class="profile-avatar">
                {% if form.instance.logo %}
                    <img src="{{ form.instance.logo.url }}" alt="{{ request.user.username }}">
                {% else %}
                    <i class="fas fa-building"></i>
                {% endif %}
            </div>
            <div class="profile-username">{{ form.instance.company_name|default:request.user.username }}</div>
            <div class="profile-email">{{ request.user.email }}</div>
        </div>
        
        <div class="profile-tabs">
            <ul class="profile-nav">
                <li class="profile-nav-item">
                    <a href="#company-info" class="profile-nav-link active" data-tab="company-info" id="company-info-tab">
                        <span class="profile-nav-icon"><i class="fas fa-building"></i></span>
                        Информация о компании
                    </a>
                </li>
                <li class="profile-nav-item">
                    <a href="#email-verification" class="profile-nav-link" data-tab="email-verification" id="email-verification-tab">
                        <span class="profile-nav-icon"><i class="fas fa-envelope"></i></span>
                        Подтверждение почты
                    </a>
                </li>
                <li class="profile-nav-item">
                    <a href="#change-password" class="profile-nav-link" data-tab="change-password" id="change-password-tab">
                        <span class="profile-nav-icon"><i class="fas fa-lock"></i></span>
                        Смена пароля
                    </a>
                </li>
                <li class="profile-nav-item">
                    <a href="#language-currency" class="profile-nav-link" data-tab="language-currency" id="language-currency-tab">
                        <span class="profile-nav-icon"><i class="fas fa-globe"></i></span>
                        Язык и валюта
                    </a>
                </li>
                <li class="profile-nav-item">
                    <a href="#upload-files" class="profile-nav-link" data-tab="upload-files" id="upload-files-tab">
                        <span class="profile-nav-icon"><i class="fas fa-file-upload"></i></span>
                        Загрузка файлов
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Содержимое вкладок -->
    <div class="profile-content">
        <!-- Вкладка с информацией о компании -->
        <div id="company-info" class="profile-tab active">
            <h2 class="profile-tab-title">Информация о компании</h2>
            
            <form method="post" enctype="multipart/form-data" id="company-form">
                {% csrf_token %}
                
                <div class="profile-card">
                    <h3 class="profile-card-title">Основная информация</h3>
                    
                    <div class="profile-form-group">
                        <label>{{ form.company_type.label }}</label>
                        <div class="company-type-toggle">
                            <input type="radio" id="type_individual" name="company_type" value="individual" {% if form.instance.company_type == 'individual' or not form.instance.company_type %}checked{% endif %}>
                            <label for="type_individual">Индивидуальный предприниматель</label>
                            
                            <input type="radio" id="type_business" name="company_type" value="business" {% if form.instance.company_type == 'business' %}checked{% endif %}>
                            <label for="type_business">Юридическое лицо</label>
                        </div>
                    </div>
                    
                    <div class="profile-form-group">
                        <label for="id_company_name">{{ form.company_name.label }}</label>
                        {{ form.company_name }}
                        {% if form.company_name.errors %}
                        <div class="form-error">{{ form.company_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="profile-form-grid">
                        <div class="profile-form-group">
                            <label for="id_legal_address">{{ form.legal_address.label }}</label>
                            {{ form.legal_address }}
                            {% if form.legal_address.errors %}
                            <div class="form-error">{{ form.legal_address.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_postal_address">{{ form.postal_address.label }}</label>
                            {{ form.postal_address }}
                            {% if form.postal_address.errors %}
                            <div class="form-error">{{ form.postal_address.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="profile-card">
                    <h3 class="profile-card-title">Контактная информация</h3>
                    
                    <div class="profile-form-grid">
                        <div class="profile-form-group">
                            <label for="id_phone">{{ form.phone.label }}</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                            <div class="form-error">{{ form.phone.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_email">{{ form.email.label }}</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <div class="form-error">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_website">{{ form.website.label }}</label>
                            {{ form.website }}
                            {% if form.website.errors %}
                            <div class="form-error">{{ form.website.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="profile-card">
                    <h3 class="profile-card-title">Реквизиты</h3>
                    
                    <div class="profile-form-grid">
                        <div class="profile-form-group">
                            <label for="id_inn">{{ form.inn.label }}</label>
                            {{ form.inn }}
                            <small class="form-help">{{ form.inn.help_text }}</small>
                            {% if form.inn.errors %}
                            <div class="form-error">{{ form.inn.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group business-only">
                            <label for="id_kpp">{{ form.kpp.label }}</label>
                            {{ form.kpp }}
                            <small class="form-help">{{ form.kpp.help_text }}</small>
                            {% if form.kpp.errors %}
                            <div class="form-error">{{ form.kpp.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_ogrn">{{ form.ogrn.label }}</label>
                            {{ form.ogrn }}
                            {% if form.ogrn.errors %}
                            <div class="form-error">{{ form.ogrn.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_okpo">{{ form.okpo.label }}</label>
                            {{ form.okpo }}
                            {% if form.okpo.errors %}
                            <div class="form-error">{{ form.okpo.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="profile-card">
                    <h3 class="profile-card-title">Банковские реквизиты</h3>
                    
                    <div class="profile-form-grid">
                        <div class="profile-form-group">
                            <label for="id_bank_name">{{ form.bank_name.label }}</label>
                            {{ form.bank_name }}
                            {% if form.bank_name.errors %}
                            <div class="form-error">{{ form.bank_name.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_bank_account">{{ form.bank_account.label }}</label>
                            {{ form.bank_account }}
                            {% if form.bank_account.errors %}
                            <div class="form-error">{{ form.bank_account.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_bank_corr_account">{{ form.bank_corr_account.label }}</label>
                            {{ form.bank_corr_account }}
                            {% if form.bank_corr_account.errors %}
                            <div class="form-error">{{ form.bank_corr_account.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_bank_bik">{{ form.bank_bik.label }}</label>
                            {{ form.bank_bik }}
                            {% if form.bank_bik.errors %}
                            <div class="form-error">{{ form.bank_bik.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="profile-tab-footer">
                    <button type="submit" class="profile-btn profile-btn-primary" name="action" value="company_info">Сохранить изменения</button>
                </div>
            </form>
        </div>
        
        <!-- Вкладка подтверждения почты -->
        <div id="email-verification" class="profile-tab">
            <h2 class="profile-tab-title">Подтверждение электронной почты</h2>
            
            {% if user.email %}
                {% if user.is_active %}
                <div class="profile-alert profile-alert-success">
                    <p><i class="fas fa-check-circle"></i> Ваша электронная почта подтверждена.</p>
                </div>
                {% else %}
                <div class="profile-alert profile-alert-warning">
                    <p><i class="fas fa-exclamation-triangle"></i> Ваша электронная почта не подтверждена.</p>
                    <p>На адрес <strong>{{ user.email }}</strong> было отправлено письмо с инструкциями по подтверждению.</p>
                </div>
                
                <div class="profile-card">
                    <h3 class="profile-card-title">Отправить письмо повторно</h3>
                    <p>Если вы не получили письмо с подтверждением, вы можете запросить повторную отправку.</p>
                    <div class="profile-form-footer">
                        <form method="post">
                            {% csrf_token %}
                            <button type="submit" name="action" value="resend_verification" class="profile-btn profile-btn-primary">Отправить повторно</button>
                        </form>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="profile-alert profile-alert-info">
                    <p><i class="fas fa-info-circle"></i> У вас не указана электронная почта. Пожалуйста, добавьте её в разделе "Информация о компании".</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Вкладка смены пароля -->
        <div id="change-password" class="profile-tab">
            <h2 class="profile-tab-title">Смена пароля</h2>
            
            <div class="profile-card">
                <h3 class="profile-card-title">Изменение пароля</h3>
                <form method="post">
                    {% csrf_token %}
                    <div class="profile-form-group">
                        <label for="id_old_password">Текущий пароль</label>
                        <input type="password" name="old_password" id="id_old_password" class="profile-form-control" required>
                    </div>
                    
                    <div class="profile-form-group">
                        <label for="id_new_password1">Новый пароль</label>
                        <input type="password" name="new_password1" id="id_new_password1" class="profile-form-control" required>
                        <small class="form-help">Пароль должен содержать не менее 8 символов, включая буквы и цифры.</small>
                    </div>
                    
                    <div class="profile-form-group">
                        <label for="id_new_password2">Подтверждение нового пароля</label>
                        <input type="password" name="new_password2" id="id_new_password2" class="profile-form-control" required>
                    </div>
                    
                    <div class="profile-form-footer">
                        <button type="submit" name="action" value="change_password" class="profile-btn profile-btn-primary">Изменить пароль</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Вкладка выбора языка и валюты -->
        <div id="language-currency" class="profile-tab">
            <h2 class="profile-tab-title">Язык и валюта</h2>
            
            <div class="profile-card">
                <h3 class="profile-card-title">Предпочтения языка</h3>
                
                <div class="language-options">
                    <div class="language-option {% if form.instance.preferred_language == 'ru' %}active{% endif %}" data-lang="ru">
                        <div class="language-flag">
                            <img src="{% static 'images/flags/ru.svg' %}" alt="Русский">
                        </div>
                        <div class="language-details">
                            <div class="language-name">Русский</div>
                            <div class="language-native">Русский</div>
                        </div>
                    </div>
                    
                    <div class="language-option {% if form.instance.preferred_language == 'en' %}active{% endif %}" data-lang="en">
                        <div class="language-flag">
                            <img src="{% static 'images/flags/gb.svg' %}" alt="English">
                        </div>
                        <div class="language-details">
                            <div class="language-name">English</div>
                            <div class="language-native">English</div>
                        </div>
                    </div>
                    
                    <div class="language-option {% if form.instance.preferred_language == 'de' %}active{% endif %}" data-lang="de">
                        <div class="language-flag">
                            <img src="{% static 'images/flags/de.svg' %}" alt="Deutsch">
                        </div>
                        <div class="language-details">
                            <div class="language-name">Deutsch</div>
                            <div class="language-native">German</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-form-footer">
                    <div class="settings-saved language-saved">
                        <i class="fas fa-check-circle"></i> Язык успешно изменен
                    </div>
                </div>
            </div>
            
            <div class="profile-card">
                <h3 class="profile-card-title">Настройки валюты</h3>
                
                <div class="currency-options">
                    <div class="currency-option {% if form.instance.preferred_currency == 'RUB' %}active{% endif %}" data-currency="RUB">
                        <div class="currency-symbol">₽</div>
                        <div class="currency-details">
                            <div class="currency-name">Российский рубль</div>
                            <div class="currency-code">RUB</div>
                        </div>
                    </div>
                    
                    <div class="currency-option {% if form.instance.preferred_currency == 'USD' %}active{% endif %}" data-currency="USD">
                        <div class="currency-symbol">$</div>
                        <div class="currency-details">
                            <div class="currency-name">Доллар США</div>
                            <div class="currency-code">USD</div>
                        </div>
                    </div>
                    
                    <div class="currency-option {% if form.instance.preferred_currency == 'EUR' %}active{% endif %}" data-currency="EUR">
                        <div class="currency-symbol">€</div>
                        <div class="currency-details">
                            <div class="currency-name">Евро</div>
                            <div class="currency-code">EUR</div>
                        </div>
                    </div>
                    
                    <div class="currency-option {% if form.instance.preferred_currency == 'GBP' %}active{% endif %}" data-currency="GBP">
                        <div class="currency-symbol">£</div>
                        <div class="currency-details">
                            <div class="currency-name">Фунт стерлингов</div>
                            <div class="currency-code">GBP</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-form-footer">
                    <div class="settings-saved currency-saved">
                        <i class="fas fa-check-circle"></i> Валюта успешно изменена
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Вкладка загрузки файлов -->
        <div id="upload-files" class="profile-tab">
            <h2 class="profile-tab-title">Загрузка файлов</h2>
            
            <div class="profile-card">
                <h3 class="profile-card-title">Логотип, печать и подпись</h3>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="profile-form-grid">
                        <div class="profile-form-group">
                            <label for="id_logo">{{ form.logo.label }}</label>
                            {% if form.instance.logo %}
                            <div class="current-file">
                                <img src="{{ form.instance.logo.url }}" alt="Текущий логотип" style="max-width: 150px; max-height: 150px;">
                                <p>Текущий файл: {{ form.instance.logo.name }}</p>
                            </div>
                            {% endif %}
                            <div class="file-upload-container">
                                <input type="file" id="id_logo" name="logo" accept="image/*" class="file-input" aria-label="Выбрать файл логотипа">
                                <label for="id_logo" class="file-upload-button">Выбрать логотип</label>
                                <span class="file-name" id="logo_filename"></span>
                            </div>
                            {% if form.logo.errors %}
                            <div class="form-error">{{ form.logo.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_stamp">{{ form.stamp.label }}</label>
                            {% if form.instance.stamp %}
                            <div class="current-file">
                                <img src="{{ form.instance.stamp.url }}" alt="Текущая печать" style="max-width: 150px; max-height: 150px;">
                                <p>Текущий файл: {{ form.instance.stamp.name }}</p>
                            </div>
                            {% endif %}
                            <div class="file-upload-container">
                                <input type="file" id="id_stamp" name="stamp" accept="image/*" class="file-input" aria-label="Выбрать файл печати">
                                <label for="id_stamp" class="file-upload-button">Выбрать печать</label>
                                <span class="file-name" id="stamp_filename"></span>
                            </div>
                            {% if form.stamp.errors %}
                            <div class="form-error">{{ form.stamp.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="profile-form-group">
                            <label for="id_signature">{{ form.signature.label }}</label>
                            {% if form.instance.signature %}
                            <div class="current-file">
                                <img src="{{ form.instance.signature.url }}" alt="Текущая подпись" style="max-width: 150px; max-height: 150px;">
                                <p>Текущий файл: {{ form.instance.signature.name }}</p>
                            </div>
                            {% endif %}
                            <div class="file-upload-container">
                                <input type="file" id="id_signature" name="signature" accept="image/*" class="file-input" aria-label="Выбрать файл подписи">
                                <label for="id_signature" class="file-upload-button">Выбрать подпись</label>
                                <span class="file-name" id="signature_filename"></span>
                            </div>
                            {% if form.signature.errors %}
                            <div class="form-error">{{ form.signature.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="profile-tab-footer">
                        <button type="submit" name="action" value="upload_files" class="profile-btn profile-btn-primary">Сохранить файлы</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Профиль компании | Billify",
  "description": "Управление профилем вашей компании в системе Billify. Редактируйте контактные данные, логотип, банковские реквизиты и другую информацию о вашей организации.",
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Главная",
        "item": "/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Профиль компании",
        "item": "/profile/"
      }
    ]
  },
  "mainEntity": {
    "@type": "Organization",
    "name": "{{ form.instance.company_name|default:'Ваша компания' }}",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "{{ form.instance.legal_address|default:'' }}"
    },
    "telephone": "{{ form.instance.phone|default:'' }}",
    "email": "{{ form.instance.email|default:request.user.email }}",
    "url": "{{ form.instance.website|default:'' }}"
  }
}
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Переключение вкладок
        const tabLinks = document.querySelectorAll('.profile-nav-link');
        const tabs = document.querySelectorAll('.profile-tab');
        
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Убираем активный класс со всех ссылок и вкладок
                tabLinks.forEach(l => {
                    l.classList.remove('active');
                });
                tabs.forEach(t => t.classList.remove('active'));
                
                // Добавляем активный класс текущей ссылке и вкладке
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Обновляем URL с помощью хэша без прокрутки
                const scrollPosition = window.scrollY;
                history.pushState(null, null, '#' + tabId);
                window.scrollTo(0, scrollPosition);
            });
        });
        
        // Проверяем хэш при загрузке страницы
        if (window.location.hash) {
            const tabId = window.location.hash.substring(1);
            const tabLink = document.querySelector(`.profile-nav-link[data-tab="${tabId}"]`);
            
            if (tabLink) {
                // Активируем вкладку без прокрутки
                tabLinks.forEach(l => {
                    l.classList.remove('active');
                });
                tabs.forEach(t => t.classList.remove('active'));
                
                tabLink.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }
        }
        
        // Обновление названия файла при загрузке
        document.querySelectorAll('.file-input').forEach(input => {
            input.addEventListener('change', function() {
                const filename = this.files[0] ? this.files[0].name : '';
                document.getElementById(this.id + '_filename').textContent = filename;
            });
        });
        
        // Показываем/скрываем поле КПП в зависимости от типа компании
        const companyTypeInputs = document.querySelectorAll('input[name="company_type"]');
        const kppField = document.querySelector('.business-only');
        
        function updateKppVisibility() {
            const isBusinessType = document.getElementById('type_business').checked;
            kppField.style.display = isBusinessType ? 'block' : 'none';
        }
        
        companyTypeInputs.forEach(input => {
            input.addEventListener('change', updateKppVisibility);
        });
        
        // Вызываем при загрузке страницы
        updateKppVisibility();
        
        // Обработка выбора языка
        const languageOptions = document.querySelectorAll('.language-option');
        const languageSaved = document.querySelector('.language-saved');
        
        languageOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Удаляем активный класс у всех опций
                languageOptions.forEach(opt => opt.classList.remove('active'));
                
                // Добавляем активный класс к выбранной опции
                this.classList.add('active');
                
                // Получаем выбранный язык
                const language = this.getAttribute('data-lang');
                
                // Отправляем AJAX-запрос для сохранения выбранного языка
                fetch('/api/change-language/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ language: language })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Показываем сообщение об успешном сохранении
                        languageSaved.classList.add('visible');
                        setTimeout(() => {
                            languageSaved.classList.remove('visible');
                        }, 3000);
                    }
                });
            });
        });
        
        // Обработка выбора валюты
        const currencyOptions = document.querySelectorAll('.currency-option');
        const currencySaved = document.querySelector('.currency-saved');
        
        currencyOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Удаляем активный класс у всех опций
                currencyOptions.forEach(opt => opt.classList.remove('active'));
                
                // Добавляем активный класс к выбранной опции
                this.classList.add('active');
                
                // Получаем выбранную валюту
                const currency = this.getAttribute('data-currency');
                
                // Отправляем AJAX-запрос для сохранения выбранной валюты
                fetch('/api/change-currency/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ currency: currency })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Показываем сообщение об успешном сохранении
                        currencySaved.classList.add('visible');
                        setTimeout(() => {
                            currencySaved.classList.remove('visible');
                        }, 3000);
                    }
                });
            });
        });
    });
</script>
{% endblock %} 